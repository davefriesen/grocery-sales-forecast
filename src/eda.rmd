---
title: "Grocery Sales Forecast"
author:
  Christine Vu^[University of San Diego, cvu@sandiego.edu], Dave Friesen^[University of San Diego, dfriesen@sandiego.edu]
date: "12/12/2022"
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
output:
  html_document:
    css: "style.css"
  pdf_document: default
---

<style>
.main-container {
  max-width: 1024px;
}
</style>


### Objective and Hypothesis

#### [. . .]


```{r setup, echo = FALSE, message = FALSE}
# Load R libraries
library(e1071)
library(readr)
library(RTextTools)
library(readxl)
library(ggplot2)
library(plotly)
library(forecast)
library(dplyr)
library(tidyr)
library(zoo)
library(lubridate)

# Expand output width and minimize exp notation
options(width = 150)
options(scipen = 100)
options(digits = 1)

# Set style defaults
knitr::opts_chunk$set(class.source = "source")
knitr::opts_chunk$set(class.output = "output")
knitr::opts_chunk$set(fig.width = 10, fig.height = (10 * .45), fig.align = "center")
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(comment = NA)
```


### Data Load and Validation

```{r data_load_validation}
# Load dataset(s); assumes folder structure with data parallel to src
sales_df <- read.csv("/Users/christinevu/Downloads/train.csv", header = TRUE)
sales_test_df <- read.csv("/Users/christinevu/Downloads/test.csv", header = TRUE)
stores_df <- read.csv("/Users/christinevu/Downloads/stores.csv", header = TRUE)
oil_df <- read.csv("/Users/christinevu/Downloads/oil.csv", header = TRUE)
events_df <- read.csv("/Users/christinevu/Downloads/holidays_events.csv", header = TRUE)

# Data validation and understanding, including structure, content, and statistical characteristics covered below
```


###### Data Structure Review

```{r data_structure_review}
# Summarize base datasets
str(sales_df)
str(sales_test_df)
str(stores_df)
str(oil_df)
str(events_df)

# [Optionally] review sample observations
head(sales_df, 5)
head(sales_test_df, 5)
head(stores_df, 5)
head(oil_df, 5)
head(events_df, 5)
```


### Univariate Analysis and Data Preparation


###### Data Profiling

```{r data_univariate, echo = FALSE}
# Note this function is generic and doesn't look for more intelligent "blank" values like "no record",
#   "not available", etc.
is_blank <- function(x) {
  classof_x <- class(x)
  result <-
    !is.na(x) &
    (((classof_x == "character") & (x == "")) |
     ((classof_x %in% c("integer", "numeric")) & (x == 0)))
  return(result)
}

# Function to format percentages (only when value exists)
format_percent <- function(x) {
  result <- formatC(x * 100, digits = 0, width = 5, format = "d", zero.print = FALSE)
  if (round(x, 0.5) != 0) result <- paste(result, "%", sep = "")
  return(result)  
}

# Function to not output NaNs from third-party functions in lapply() below
nan_replace_0 <- function(x) {
  if (is.nan(x)) result <- 0 else result = x
  return(result)
}

# Function to Generate a summary of base dataset
univariate <- function(df) {
  rowcount <- nrow(df)
  ua <- do.call(rbind, lapply(df, function(x) c(
    colnames(x),
    class(x),
    format_percent(sum(is.na(x)) / rowcount),
    format_percent(sum(is_blank(x)) / rowcount),
    formatC(length(unique(na.omit(x))),
            digits = 0, width = 9, format = "d", big.mark = ",", zero.print = FALSE),
    formatC(ifelse(is.numeric(x), min(na.omit(x)), 0),
            digits = 0, width = 9, format = "f", big.mark = ",", zero.print = FALSE),
#            digits = ifelse(is.double(x), 3, 0), width = 9, format = "f", big.mark = ",", zero.print = FALSE),
    formatC(ifelse(is.numeric(x), max(na.omit(x)), 0),
            digits = 0, width = 9, format = "f", big.mark = ",", zero.print = FALSE),
#            digits = ifelse(is.double(x), 3, 0), width = 9, format = "f", big.mark = ",", zero.print = FALSE),
    formatC(ifelse(is.double(x), mean(na.omit(x)), 0),
            digits = 0, width = 9, format = "f", big.mark = ",", zero.print = FALSE),
#            digits = 3, width = 9, format = "f", big.mark = ",", zero.print = FALSE),
    formatC(ifelse(is.numeric(x), median(na.omit(x)), 0),
            digits = 0, width = 9, format = "f", big.mark = ",", zero.print = FALSE),
#            digits = ifelse(is.double(x), 3, 0), width = 9, format = "f", big.mark = ",", zero.print = FALSE),
    format(ifelse(is.numeric(x),
           ifelse(na.omit(x) < (quantile(na.omit(x), 0.25) - (1.5 * IQR(na.omit(x)))), "Yes", "No"), ""),
           justify = "centre", width = 8, format = "s"),
    format(ifelse(is.numeric(x),
           ifelse(na.omit(x) > (quantile(na.omit(x), 0.75) - (1.5 * IQR(na.omit(x)))), "Yes", "No"), ""),
           justify = "centre", width = 8, format = "s"),
    formatC(ifelse(is.numeric(x), nan_replace_0(skewness(na.omit(x))), 0),
            digits = 2, width = 8, format = "f", zero.print = FALSE),
    formatC(ifelse(is.numeric(x), nan_replace_0(kurtosis(na.omit(x))), 0),
            digits = 2, width = 8, format = "f", zero.print = FALSE))))
  colnames(ua) <- c(
    "Type",
    format("NA", justify = "right", width = 6),
    format("BlankZ", justify = "right", width = 6),
    format("Unique", justify = "right", width = 9),
    format("Min", justify = "right", width = 9),
    format("Max", justify = "right", width = 9),
    format("Mean", justify = "right", width = 9),
    format("Median", justify = "right", width = 9),
    format("Outlier<", justify = "centre", width = 8),
    format(">Outlier", justify = "centre", width = 8),
    format("Kurtosis", justify = "right", width = 8),
    format("Skewness", justify = "right", width = 8))
  row.names(ua) <- lapply(row.names(ua),
                          function(x) if (nchar(x) > 20) return(paste(substr(x, 1, 17), "...", sep = ""))
                          else return(x))
  { cat(
    "Summary Univariate Analysis (",
    formatC(rowcount, big.mark = ","), " observations)\n",
    sep = "")
    print(noquote(ua))
  }
}
```

```{r data_profiling}
# e.g., statistical characteristics (including distribution, skewness, outliers)
univariate(sales_df)
univariate(sales_test_df)
univariate(stores_df)
univariate(oil_df)
univariate(events_df)
```

```{r}
# Data summary statistics
summary(sales_df)
summary(sales_test_df)
summary(stores_df)
summary(oil_df)
summary(events_df)
```

```{r}
# Proportion by family
fam_prop <- sales_df %>%
              group_by(family) %>%
              summarise(Mean_Sales = round(mean(sales, na.rm = TRUE), 2),
                        Median_Sales = round(median(sales, na.rm = TRUE), 2),
                        Maximum_Sales = max(sales),
                        IQR_Sales = IQR(sales),
                        Total_Sales = sum(sales))

head(fam_prop, 3)
```

```{r}
# Box plot: Mean of store sales by family
fam_plot <- ggplot(fam_prop) +
            geom_col(aes(x = family, y = Mean_Sales, fill = family)) +
            theme(axis.ticks.x = element_blank(),
                  axis.text.x = element_blank()) +
            labs(title = "Average Store Sales by Family",
                 x = "Family of Product",
                 y = "Average of Daily Sales",
                 legend = "Family of Product Sold",
                 bty = "l")

ggplotly(fam_plot)
```

```{r}
# Box plot: Total store sales by family
fam_plot2 <- ggplot(fam_prop) +
             geom_col(aes(x = family, y = Total_Sales, fill = family)) +
             theme(axis.ticks.x = element_blank(),
                   axis.text.x = element_blank()) +
             labs(title = "Total Store Sales by Family",
                  x = "Family of Product",
                  y = "Average of Daily Sales",
                  legend = "Family of Product Sold",
                  bty = "l")

ggplotly(fam_plot2)
```

```{r}
# Extract day, month, year, etc. from sales_df
sales_df$day <- sales_df$date %>% day()
sales_df$month <- sales_df$date %>% month()
sales_df$month_lab <- sales_df$date %>% month(label = TRUE)
sales_df$year <- sales_df$date %>% year()
sales_df$week <- sales_df$date %>% week()
sales_df$week_day <- sales_df$date %>%
  wday(week_start = getOption("lubridate.week.start", 1), label = TRUE)
```

```{r}
# Proportion by sales
sales_prop <- sales_df %>%
                group_by(store_nbr) %>%
                summarise(Mean_Sales = mean(sales),
                          Median_Sales = median(sales),
                          Maximum_Sales = max(sales),
                          IQR_Sales = IQR(sales),
                          IQR_to_avg_sales = IQR(sales) / mean(sales),
                          Total_Sales = sum(sales))

head(sales_prop, 3)
```

```{r}
# Bar plot: Average of store sales by day of the week in January 2013
sales_plot <- sales_df %>%
                group_by(date) %>%
                  summarise(avg_sales = mean(sales), wday = week_day, .groups = "keep") %>%
                    filter(date <= '2013-01-31') %>% 
                      ggplot() +
                      geom_col(aes(x = date, y = avg_sales, fill = wday)) +
                      labs(title = "Average of Daily Store Sales in January 2013",
                           x = "Date",
                           y = "Average of Daily Sales",
                           fill = "Day of the Week",
                           bty = "l")
sales_plot2
```

```{r}
# Bar plot: Average of store sales by day of the week
sales_plot1 <- sales_df %>%
                group_by(week_day) %>%
                  summarise(avg_sales = mean(sales)) %>% 
                    ggplot() +
                    geom_col(aes(x = week_day,
                                 y = avg_sales,
                                 fill = week_day)) +
                    labs(title = "Average of Daily Store Sales by Day of the Week",
                         x = "Day of the Week",
                         y = "Average of Daily Sales",
                         fill = "Day of the Week",
                         bty = "l")
sales_plot1

# Bar plot: Average of store sales by week
sales_plot2 <- sales_df %>%
                group_by(week) %>%
                  summarise(avg_sales = mean(sales)) %>% 
                    ggplot() +
                    geom_col(aes(x = week,
                                 y = avg_sales,
                                 fill = as.factor(week))) +
                    labs(title = "Average of Daily Store Sales by Week",
                         x = "Week",
                         y = "Average of Weekly Sales",
                         fill = "Week",
                         bty = "l")
sales_plot2

# Bar plot: Average of store sales by month of the year
sales_plot3 <- sales_df %>%
                group_by(month_lab) %>%
                  summarise(avg_sales = mean(sales)) %>% 
                    ggplot() +
                    geom_col(aes(x = month_lab,
                                 y = avg_sales,
                                 fill = month_lab)) +
                    labs(title = "Average of Daily Store Sales by Month of the Year",
                         x = "Month",
                         y = "Average of Monthly Sales",
                         fill = "Month",
                         bty = "l")
sales_plot3

# Bar plot: Average of store sales by year
sales_plot4 <- sales_df %>%
                group_by(year) %>%
                  summarise(avg_sales = mean(sales)) %>% 
                    ggplot() +
                    geom_col(aes(x = year,
                                 y = avg_sales,
                                 fill = as.factor(year))) +
                    labs(title = "Average of Daily Store Sales by Year",
                         x = "Year",
                         y = "Average of Yearly Sales",
                         fill = "Year",
                         bty = "l")
sales_plot4
```

```{r}
# Bar plot: Distribution of store types
store_plot <- stores_df$type %>%
                table() %>% 
                  as.data.frame() %>% 
                    ggplot() +
                    geom_col(aes(y = Freq, x = ., fill = as.factor(.))) +
                    labs(title = "Distribution of Store Types",
                         x = "Store Type",
                         fill = "Type",
                         bty = "l")

store_plot
```

```{r}
# Bar plot: Distribution of holiday type
events_plot1 <- events_df %>%
                  ggplot() +
                  geom_bar(aes(x = type, fill = type)) +
                  labs(title = "Distrbution of Type of Holiday",
                       x = "Type of Holiday",
                       fill = "Holiday Type",
                       bty = "l")
events_plot1

# Bar plot: Distribution of holiday locale
events_plot2 <- events_df %>%
                  ggplot() +
                  geom_bar(aes(x = locale, fill = locale)) +
                  labs(title = "Distribution of Holiday Locale",
                       x = "Holiday Locale",
                       fill = "Locale",
                       bty = "l")
events_plot2
```

```{r}
# Line chart: Daily oil price
oil_plot <- oil_df %>%
              ggplot(aes(x = date, y = dcoilwtico, color = dcoilwtico, group = 1)) +
              geom_line(na.rm = TRUE) +
              labs(title = "Daily Oil Price",
                   x = "Date",
                   y = "Oil Price",
                   color = "Oil Price",
                   bty = "l")
oil_plot
```


###### Preliminary Feature Reduction (clearly n/a to Objective and Hypothesis)


###### Attribute Names (confirm/update)


###### Target and Feature Identification (preliminary)


###### Data Types (confirm/update)
```{r}
lapply(sales_df, class)
lapply(sales_test_df, class)
lapply(stores_df, class)
lapply(oil_df, class)
lapply(events_df, class)
```


###### Time Series Objects
```{r}
# Convert string mm/dd/yyyy to Date values and confirm sort
sales_df <- (sales_df %>%
               mutate(date = as.Date(date, format = "%Y-%m-%d"),) %>%
               arrange(date))
```

```{r}
# Aggregate base dataframe by date (i.e., sum all product lines) and initially plot series at
#   provided time granularity
sales_agg_df <- as.data.frame(sales_df %>%
                                group_by(date) %>%
                                summarize(sales = sum(sales / 1000.0)))
plot(x = sales_agg_df$date, y = sales_agg_df$sales, type = "l",
     main = "Store Sales for All Product Families  |  Daily  |  All Dates",
     xlab = TeX(r"(\textbf{Date (daily \textit{$t$})} )"), ylab = TeX(r"(\textbf{Sales (\textit{$y_t$})} (000) )"),
     las = 1, cex.axis = 0.7)
```

```{r}
# Aggregate base dataframe from daily to weekly for all product families
sales_wk_df <- as.data.frame(sales_df %>%
                               mutate(year = year(date), week = week(date)) %>%
                               group_by(year, week) %>%
                               summarize(sales = sum(sales / 1000.0)))

# Create overall time series
sales_begin_year <- head(sales_wk_df$year, 1)
sales_begin_week <- head(sales_wk_df$week, 1)
sales_end_year <- tail(sales_wk_df$year, 1)
sales_end_week <- tail(sales_wk_df$week, 1)
sales_ts <- ts(sales_wk_df$sales,
               start = c(sales_begin_year, sales_begin_week),
               end = c(sales_end_year, sales_end_week), freq = 52)

# Plot overall time series with trend line
plot(sales_ts, type = "l",
     main = "Store Sales for All Product Families  |  Weekly  |  All Dates",
     xlab = TeX(r"(\textbf{Date (weekly \textit{$t$})} )"), ylab = TeX(r"(\textbf{Sales (\textit{$y_t$})} (000) )"),
     las = 1, cex.axis = 0.7)

sales_lm <- tslm(sales_ts ~ trend + I(trend^2))
lines(sales_lm$fitted, lwd = 2, lty = 1, col = "red")

legend("bottomright",
       legend = c("Trend Line"),
       col = c("red"),
       lwd = 2, lty = 1.2, cex = 0.8,
       box.lty = 0, bg = NULL, text.col = "red")
```

```{r}
# Convert data to time series objects
train.ts <- ts(sales_df$sales, start = c(1, 1), freq = 52)
test.ts <- ts(sales_test_df$family, start = c(1, 1), freq = 52)
stores.ts <- ts(stores_df$cluster, start = c(1, 1), freq = 52)
oil.ts <- ts(oil_df$dcoilwtico, start = c(1, 1), freq = 52)
#events.ts <- ts(holiday_events$sales, start = c(1, 1), freq = 52)
```


###### Data Enrichment


###### Categorical Data Profiling


### Data Partitioning
```{r}
# Count rows
nrow(sales_df)
nrow(sales_test_df)

# Count columns
ncol(sales_df)
ncol(sales_test_df)
```

```{r}
# Use one year (52 weeks) as validation period (representative set of quarters, seasons)
sales_n_valid <- 52
sales_n_train <- length(sales_ts) - sales_n_valid

# Split data into training and validation periods
sales_train_ts <- window(sales_ts, start = c(sales_begin_year, 1), end = c(sales_begin_year, sales_n_train))
sales_valid_ts <- window(sales_ts, start = c(sales_begin_year, sales_n_train + 1), end = c(sales_begin_year, sales_n_train + sales_n_valid))

# Set x axis values based on ts ranges
x_train <- sales_begin_year
x_valid <- sales_begin_year + ((sales_n_train + 1) / 52)
x_future <- x_valid + ((sales_n_valid + 1) / 52)
```

```{r}
# Remove rows not considered "core"
keep_families <- c("BEAUTY", "BEVERAGES", "BREAD/BAKERY", "CLEANING", "DAIRY",
                   "DELI", "EGGS", "FROZEN FOODS", "GROCERY", "GROCERY II", "HARDWARE",
                   "LIQUOR,WINE,BEER", "MEATS", "PERSONAL CARE", "PET SUPPLIES", "POULTRY",
                   "PREPARED FOODS", "PRODUCE", "SEAFOOD")
remove_families <- c("AUTOMOTIVE", "BABY CARE", "BOOKS", "CELEBRATION", "HOME APPLIANCES",
                     "HOME AND KITCHEN I", "HOME AND KITCHEN II", "HOME CARE", "LADIESWEAR",
                     "LAWN AND GARDEN", "LINGERIE", "MAGAZINES", "PET SUPPLIES",
                     "PLAYERS AND ELECTRONICS", "SCHOOL AND OFFICE SUPPLIES")
sales_core_df <- (sales_df %>%
                    filter(family %in% keep_families))
```

```{r}
# Re-aggregate base dataframe from daily to weekly for all product families
sales_wk_df <- as.data.frame(sales_core_df %>%
                               mutate(year = year(date), week = week(date)) %>%
                               group_by(year, week) %>%
                               summarize(sales = sum(sales / 1000.0)))
# Re-create overall time series
sales_begin_year <- head(sales_wk_df$year, 1)
sales_begin_week <- head(sales_wk_df$week, 1)
sales_end_year <- tail(sales_wk_df$year, 1)
sales_end_week <- tail(sales_wk_df$week, 1)
sales_ts <- ts(sales_wk_df$sales,
               start = c(sales_begin_year, sales_begin_week),
               end = c(sales_end_year, sales_end_week), freq = 52)
```

### Additional Uni/Multivariate EDA and Feature Engineering/Selection


###### Missing/null values (find/impute/drop)
```{r}
# Count missing values
sum(is.na(sales_df))
sum(is.na(sales_test_df))
sum(is.na(stores_df))
sum(is.na(oil_df))
sum(is.na(events_df))
```

```{r}
# Mean of missing oil_df data
mean(is.na(oil_df))

# Option: Drop missing records since they only account for 2% of data
# na.omit(oil_df)

# oil_df2: New 'oil_df' data frame without missing values
# Foward and backward fill for missing values
oil_df2 <- na.locf(oil_df, fromLast = TRUE)

# Confirm oil_df2 has no more missing values
sum(is.na(oil_df2))
```


###### Categorical features (encoding)


###### Outliers (convert/drop)
```{r}
# Box plot: oil_df2
oil_outliers <- ggplot(oil_df2) +
                aes(x = "", y = dcoilwtico) +
                geom_boxplot(fill = "#56B4E9") +
                labs(title = "Oil Box Plot",
                     x = "",
                     y = "Oil Price",
                     bty = "l")
oil_outliers
```


###### Zero/Near-Zero Variances (find/address)


###### Centering/scaling (standardizing/normalizing)


###### Collinearity and Dependencies (find/address)


###### "Noisy"/duplicate data (find/convert/drop)


### Data Mining (Unsupervised)


### Modeling
```{r}
# Time plot: Sales
plot(sales_ts,
     main = "Weekly Store Sales",
     xlab = "Week",
     ylab = "Sales",
     bty = "l")

# ACF plot: Sales
Acf(sales_ts, lag.max = 1)

# Time plot: Differenced series of sales
plot(diff(sales_ts, lag = 1),
     main = "Store Sales Differenced Series",
     ylab = "Sales",
     bty = "l")
```

```{r}
# Random walk from AR model
fit <- Arima(sales_ts, order = c(1, 0, 0))
fit

2 * pt(-abs((1 - fit$coef["ar1"]) / 0.04), df = length(sales_ts) - 1)
```

```{r}
# Decomposition of weekly sales
stl.run <- stl(sales_ts, s.window = "periodic")

plot(stl.run)
```

```{r}
# Fitting AR(1) model to the residual series
train.lm.trend.season <- tslm(sales_ts ~ trend + I(trend^2) + season)
train.res.arima <- Arima(train.lm.trend.season$residuals, order = c(1,0,0))
train.res.arima.pred <- forecast(train.res.arima, h = nValid)

plot(train.lm.trend.season$residuals,
     main = "Store Sales AR(1) Model to Residual Series",
     xlab = "Time",
     ylab = "Residuals",
     bty = "l",
     xaxt = "n")

axis(1, at = seq(2013, 2017, 1), labels = format(seq(2013, 2017, 1)))

lines(train.res.arima.pred$fitted, lwd = 2, col = "blue")

summary(train.res.arima)
```


###### Final Feature Selection


###### Model Setup (Selection)


###### Model Run and Evaluation (Iteration n)


###### Optimization, Tuning, Selection
